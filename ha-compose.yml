services:
  mqtt-broker:
    image: eclipse-mosquitto:latest
    container_name: mqtt-broker
    # labels:  # Use the traefik labels only if MQTT comes from traefik; otherwise comment out
    # - traefik.http.routers.mqtt.rule=Host(`${MQTT_URL}`)
    # - traefik.http.routers.mqtt.entrypoints=websecure
    # - traefik.http.routers.mqtt.tls.certresolver=letsencrypt
    ports:
      - "8883:8883"   # TLS MQTT (recommended for secure usage, use "1883:1883" for plain MQTT)
    volumes: 
      - /opt/docker/vps-stack/mosquitto/config:/mosquitto/config
      - /opt/docker/vps-stack/mosquitto/data:/mosquitto/data
      - /opt/docker/vps-stack/mosquitto/log:/mosquitto/log
    networks:
      ha-net:
        ipv4_address: 192.168.0.11
    restart: unless-stopped

  acme:   # ACME protocol client, used to issue + renew certificates
    image: neilpang/acme.sh
    container_name: acme-mqtt
    restart: unless-stopped
    env_file:
      - /opt/docker/vps-stack/env/acme.env
    volumes:
      - /opt/docker/vps-stack/acme-config:/acme.sh
      - /opt/docker/vps-stack/mosquitto/renew-hook.sh:/renew-hook.sh:ro
      - /opt/docker/vps-stack/mosquitto/config:/mosquitto-config
    command: daemon

  ha01:
    image: homeassistant/home-assistant:stable
    container_name: ha01
    labels:
      - traefik.enable=true
      - traefik.http.routers.ha01.rule=Host(`${HA01_URL}`)
      - traefik.http.routers.ha01.entrypoints=websecure
      - traefik.http.routers.ha01.tls.certresolver=letsencrypt
      - traefik.http.services.ha01.loadbalancer.server.port=8123
    volumes:
      - /opt/docker/vps-stack/homeassistant/ha01-config:/config 
    environment:
      - TZ=${TZ}
    networks:
      ha-net:
        ipv4_address: 192.168.0.101
    restart: unless-stopped

  ha02:
    image: homeassistant/home-assistant:stable
    container_name: ha02
    labels:
      - traefik.enable=true
      - traefik.http.routers.ha02.rule=Host(`${HA02_URL}`)
      - traefik.http.routers.ha02.entrypoints=websecure
      - traefik.http.routers.ha02.tls.certresolver=letsencrypt
      - traefik.http.services.ha02.loadbalancer.server.port=8123
    volumes:
      - /opt/docker/vps-stack/homeassistant/ha02-config:/config 
    environment:
      - TZ=${TZ}
    networks:
      ha-net:
        ipv4_address: 192.168.0.102
    restart: unless-stopped
